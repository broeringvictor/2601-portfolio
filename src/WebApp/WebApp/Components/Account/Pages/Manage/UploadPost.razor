@page "/Account/Manage/UploadPost"

@using System.Text.Json
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using WebApp.Data
@using WebApp.Entities
@using WebApp.Services

@attribute [Authorize]

@inject ApplicationDbContext Db
@inject MarkdownService MarkdownService
@inject IdentityRedirectManager RedirectManager

<PageTitle>Upload Post</PageTitle>

<h3 class="mb-4 text-xl font-bold text-gray-900 dark:text-slate-100">Upload Post</h3>
<StatusMessage />

<div class="max-w-md">
    <form method="post" enctype="multipart/form-data" @formname="upload-post" @onsubmit="OnSubmitAsync">
        <AntiforgeryToken />
        <div class="mb-4">
            <label for="file" class="mb-1 block text-sm font-medium text-gray-700 dark:text-slate-300">Markdown file (.md)</label>
            <input type="file" name="file" id="file" accept=".md"
                   class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100" />
        </div>
        <button type="submit"
                class="w-full rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900">
            Upload
        </button>
    </form>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private async Task OnSubmitAsync()
    {
        var form = await HttpContext.Request.ReadFormAsync();
        var file = form.Files["file"];

        if (file is null || file.Length == 0)
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: No file selected.", HttpContext);
            return;
        }

        if (Path.GetExtension(file.FileName) != ".md")
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: Only .md files are allowed.", HttpContext);
            return;
        }

        using var reader = new StreamReader(file.OpenReadStream());
        var content = await reader.ReadToEndAsync();

        var hasJsonMeta = Regex.IsMatch(content, @"```json\s+meta\s*\n([\s\S]*?)```");
        var hasYamlMeta = Regex.IsMatch(content, @"^---\s*\r?\n[\s\S]*?\r?\n---");
        if (!hasJsonMeta && !hasYamlMeta)
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: The file must contain a ```json meta``` block or YAML front matter (---) with post metadata.", HttpContext);
            return;
        }

        BlogPost parsed;
        try
        {
            parsed = MarkdownService.ParsePost(content);
        }
        catch
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: The json meta block contains invalid JSON.", HttpContext);
            return;
        }

        var missing = new List<string>();
        if (string.IsNullOrWhiteSpace(parsed.Title)) missing.Add("title");
        if (string.IsNullOrWhiteSpace(parsed.Slug)) missing.Add("slug");
        if (string.IsNullOrWhiteSpace(parsed.Author)) missing.Add("author");
        if (string.IsNullOrWhiteSpace(parsed.Excerpt)) missing.Add("excerpt");
        if (parsed.PublishedAt == default) missing.Add("publishedAt");

        if (missing.Count > 0)
        {
            RedirectManager.RedirectToCurrentPageWithStatus($"Error: Missing required fields in json meta: {string.Join(", ", missing)}.", HttpContext);
            return;
        }

        var existing = await Db.BlogPosts.FirstOrDefaultAsync(p => p.Slug == parsed.Slug);
        if (existing is not null)
        {
            existing.Title = parsed.Title;
            existing.Lead = parsed.Lead;
            existing.IsPublished = parsed.IsPublished;
            existing.PublishedAt = parsed.PublishedAt;
            existing.Author = parsed.Author;
            existing.Excerpt = parsed.Excerpt;
            existing.OpenGraphImage = parsed.OpenGraphImage;
            existing.TagsJson = parsed.TagsJson;
            existing.MarkdownContent = content;
        }
        else
        {
            parsed.MarkdownContent = content;
            Db.BlogPosts.Add(parsed);
        }

        await Db.SaveChangesAsync();

        var action = existing is not null ? "updated" : "uploaded";
        RedirectManager.RedirectToCurrentPageWithStatus($"Post '{parsed.Title}' {action} successfully.", HttpContext);
    }
}
